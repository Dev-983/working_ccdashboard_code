<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>BPX Dashboard</title>
    <!-- plugins:css -->
    <link rel="stylesheet" href="{{ url_for('static', filename='assets/vendors/mdi/css/materialdesignicons.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='assets/vendors/ti-icons/css/themify-icons.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='assets/vendors/css/vendor.bundle.base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='assets/vendors/font-awesome/css/font-awesome.min.css') }}">
    <!-- endinject -->
    <!-- Plugin css for this page -->
    <link rel="stylesheet" href="{{ url_for('static', filename='assets/vendors/select2/select2.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='assets/vendors/select2-bootstrap-theme/select2-bootstrap.min.css') }}">
    <!-- End plugin css for this page -->
    <!-- inject:css -->
    <!-- endinject -->
    <!-- Layout styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/style.css') }}">
    <!-- End layout styles -->
    <link rel="shortcut icon" href="{{ url_for('static', filename='assets/images/favicon.png') }}" />
    <style type="text/css">
    <style>
        .draggable-container {
            cursor: move;
        }
        .box {
            width: 280px; /* Adjust width as needed */
            height: 90px; /* Adjust height as needed */
            border: 1px solid #000;
            padding: 10px;
            border-radius: 20px;
            overflow: auto; /* Allows scroll if content overflows */
            word-wrap: break-word; /* Prevents long words from overflowing */
            box-sizing: border-box; /* Includes padding in width/height */
        }
        .table thead th {font-size: 25px;}
    </style>
  </head>

  <body>
    <div class="container-scroller">
      <!-- partial:../../partials/_navbar.html -->
      <nav class="navbar default-layout-navbar col-lg-12 col-12 p-0 fixed-top d-flex flex-row">
        <div class="text-center navbar-brand-wrapper d-flex align-items-center justify-content-start">
          <a class="navbar-brand brand-logo" href="#" ><img src="{{ url_for('static', filename='assets/images/bpxlogo.svg') }}" alt="logo" />
          </a>
        </div>
        <div class="navbar-menu-wrapper d-flex align-items-stretch">
          <button class="navbar-toggler navbar-toggler align-self-center" type="button" data-toggle="minimize">
            <span class="mdi mdi-menu"></span>
          </button>
          <div class="search-field d-none d-md-block">
            <form class="d-flex align-items-center h-100" action="#">
              <div class="input-group">
                <div class="input-group-prepend bg-transparent">
                  <i class="input-group-text border-0 mdi mdi-magnify"></i>
                </div>
                <input type="text" class="form-control bg-transparent border-0" placeholder="Search projects">
              </div>
            </form>
          </div>
          <ul class="navbar-nav navbar-nav-right">
         
            <li class="nav-item d-none d-lg-block full-screen-link">
              <a class="nav-link">
                <i class="mdi mdi-fullscreen" id="fullscreen-button"></i>
              </a>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link count-indicator dropdown-toggle" id="messageDropdown" href="#" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="mdi mdi-email-outline"></i>
                <span class="count-symbol bg-warning"></span>
              </a>
              <div class="dropdown-menu dropdown-menu-end navbar-dropdown preview-list" aria-labelledby="messageDropdown">
                <h6 class="p-3 mb-0">Messages</h6>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item preview-item">
                  <div class="preview-thumbnail">
                    <!-- <img src="../../assets/images/faces/face4.jpg" alt="image" class="profile-pic"> -->
                  </div>
                  <div class="preview-item-content d-flex align-items-start flex-column justify-content-center">
                    <h6 class="preview-subject ellipsis mb-1 font-weight-normal">Mark send you a message</h6>
                    <p class="text-gray mb-0"> 1 Minutes ago </p>
                  </div>
                </a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item preview-item">
                  <div class="preview-thumbnail">
                    <!-- <img src="../../assets/images/faces/face2.jpg" alt="image" class="profile-pic"> -->
                  </div>
                  <div class="preview-item-content d-flex align-items-start flex-column justify-content-center">
                    <h6 class="preview-subject ellipsis mb-1 font-weight-normal">Cregh send you a message</h6>
                    <p class="text-gray mb-0"> 15 Minutes ago </p>
                  </div>
                </a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item preview-item">
                  <div class="preview-thumbnail">
                    <!-- <img src="../../assets/images/faces/face3.jpg" alt="image" class="profile-pic"> -->
                  </div>
                  <div class="preview-item-content d-flex align-items-start flex-column justify-content-center">
                    <h6 class="preview-subject ellipsis mb-1 font-weight-normal">Profile picture updated</h6>
                    <p class="text-gray mb-0"> 18 Minutes ago </p>
                  </div>
                </a>
                <div class="dropdown-divider"></div>
                <h6 class="p-3 mb-0 text-center">4 new messages</h6>
              </div>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link count-indicator dropdown-toggle" id="notificationDropdown" href="#" data-bs-toggle="dropdown">
                <i class="mdi mdi-bell-outline"></i>
                <span class="count-symbol bg-danger"></span>
              </a>
              <div class="dropdown-menu dropdown-menu-end navbar-dropdown preview-list" aria-labelledby="notificationDropdown">
                <h6 class="p-3 mb-0">Notifications</h6>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item preview-item">
                  <div class="preview-thumbnail">
                    <div class="preview-icon bg-success">
                      <i class="mdi mdi-calendar"></i>
                    </div>
                  </div>
                  <div class="preview-item-content d-flex align-items-start flex-column justify-content-center">
                    <h6 class="preview-subject font-weight-normal mb-1">Event today</h6>
                    <p class="text-gray ellipsis mb-0"> Just a reminder that you have an event today </p>
                  </div>
                </a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item preview-item">
                  <div class="preview-thumbnail">
                    <div class="preview-icon bg-warning">
                      <i class="mdi mdi-cog"></i>
                    </div>
                  </div>
                  <div class="preview-item-content d-flex align-items-start flex-column justify-content-center">
                    <h6 class="preview-subject font-weight-normal mb-1">Settings</h6>
                    <p class="text-gray ellipsis mb-0"> Update dashboard </p>
                  </div>
                </a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item preview-item">
                  <div class="preview-thumbnail">
                    <div class="preview-icon bg-info">
                      <i class="mdi mdi-link-variant"></i>
                    </div>
                  </div>
                  <div class="preview-item-content d-flex align-items-start flex-column justify-content-center">
                    <h6 class="preview-subject font-weight-normal mb-1">Launch Admin</h6>
                    <p class="text-gray ellipsis mb-0"> New admin wow! </p>
                  </div>
                </a>
                <div class="dropdown-divider"></div>
                <h6 class="p-3 mb-0 text-center">See all notifications</h6>
              </div>
            </li>
            <li class="nav-item nav-logout d-none d-lg-block">
              <a class="nav-link" href="#">
                <i class="mdi mdi-power"></i>
              </a>
            </li>
            <li class="nav-item nav-settings d-none d-lg-block">
              <a class="nav-link" href="#">
                <i class="mdi mdi-format-line-spacing"></i>
              </a>
            </li>
          </ul>
          <button class="navbar-toggler navbar-toggler-right d-lg-none align-self-center" type="button" data-toggle="offcanvas">
            <span class="mdi mdi-menu"></span>
          </button>
        </div>
      </nav>
      <!-- partial -->
      <div class="container-fluid page-body-wrapper">
        <!-- partial:../../partials/_sidebar.html -->
        <nav class="sidebar sidebar-offcanvas" id="sidebar">
          <ul class="nav">

            <li class="nav-item">
              <a class="nav-link" href="/">
                <span class="menu-title">Dashboard</span>
                <i class="mdi mdi-home menu-icon"></i>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/projectoverview">
                <span class="menu-title">Project Overview</span>
                <i class="mdi mdi-clipboard-outline menu-icon"></i>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/finance">
                <span class="menu-title">Financial Foecast</span>
                <i class="mdi mdi-chart-line menu-icon"></i>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/projectactivity">
                <span class="menu-title">Project Activity</span>
                <i class="mdi  mdi-clipboard-text menu-icon"></i>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/studytimeline2">
                <span class="menu-title">Project Study</span>
                <i class="mdi mdi-apps menu-icon"></i>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/notes_issues">
                <span class="menu-title">Notes & Issue</span>
                <i class="mdi mdi-calendar-check menu-icon"></i>
              </a>
            </li>

          </ul>
        </nav>
        <!-- partial -->
        <div class="main-panel">
          <div class="content-wrapper">
            <div class="page-header">
              <h3 class="page-title"> Notes And Issues </h3>
              <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                  <li class="breadcrumb-item"><a href="/">Home</a></li>
                  <li class="breadcrumb-item active" aria-current="page">Notes & Issues </li>
                </ol>
              </nav>
            </div>
            <div class="row">
              <div class="col-12 grid-margin">
                <div class="card">
                  <div class="card-body">
                    <button class="btn btn-primary" onclick="saveData()">SAVE</button>
                    <button class="btn btn-info" onclick="addNewRowAtTop()"> ADD</button>
  <table class="table table-striped" id="issuetable" style="margin-top: 50px;">
        <thead>
          <th>Pre Aproval </th>
          <th>Post Approval </th>
          <th>Completed</th>
        </thead>
        {% for row_index in range(data|length) %}
        <tr>
            {% for col_index in range(data[row_index]|length) %}
            <td>
              <span class="{{data[row_index][col_index].lock}}" style="font-size: 25px;"></span>         
            <div class="draggable-container" ondrop="drop(event)" ondragover="allowDrop(event)">
                <div class="box" id="box_{{ row_index }}_{{ col_index }}" contenteditable="true" draggable="true" ondragstart="drag(event)">
                    {{ data[row_index][col_index].content }}
                </div>
            </div>
            </td>
            {% endfor %}
        </tr>
        {% endfor %}
    </table>
                    
                   
                  </div>
                </div>
              </div>

   
              <div class="col-md-6 grid-margin stretch-card">
                <div class="card">

            </div>
          </div>
          <!-- content-wrapper ends -->
          <!-- partial:../../partials/_footer.html -->
          <footer class="footer">
            <div class="d-sm-flex justify-content-center justify-content-sm-between">
              <span class="text-muted text-center text-sm-left d-block d-sm-inline-block"><h4>BPX Team</h4></span>
              <span class="float-none float-sm-right d-block mt-1 mt-sm-0 text-center">helpdesk@bpx.ai</span>
            </div>
          </footer>
          <!-- partial -->
        </div>
        <!-- main-panel ends -->
      </div>
      <!-- page-body-wrapper ends -->
    </div>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <!-- container-scroller -->
    <!-- plugins:js -->
    <script src="{{ url_for('static', filename='assets/vendors/js/vendor.bundle.base.js') }}"></script>
    <!-- endinject -->
    <!-- Plugin js for this page -->
    <script src="{{ url_for('static', filename='assets/vendors/select2/select2.min.js') }}"></script>
    <script src="{{ url_for('static', filename='assets/vendors/typeahead.js/typeahead.bundle.min.js') }}"></script>
    <!-- End plugin js for this page -->
    <!-- inject:js -->
    <script src="{{ url_for('static', filename='assets/js/off-canvas.js') }}"></script>
    <script src="{{ url_for('static', filename='assets/js/misc.js') }}"></script>
    <script src="{{ url_for('static', filename='assets/js/settings.js') }}"></script>
    <script src="{{ url_for('static', filename='assets/js/todolist.js') }}"></script>
    <script src="{{ url_for('static', filename='assets/js/jquery.cookie.js') }}"></script>
    <!-- endinject -->
    <!-- Custom js for this page -->
    <script src="{{ url_for('static', filename='assets/js/file-upload.js') }}"></script>
    <script src="{{ url_for('static', filename='assets/js/typeahead.js') }}"></script>
    <script src="{{ url_for('static', filename='assets/js/select2.js') }}"></script>
    <!-- End custom js for this page -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

  <script>
document.addEventListener("DOMContentLoaded", function() {
  // Add event listener to all lock/unlock icons
  const lockIcons = document.querySelectorAll('.mdi-lock, .mdi-lock-open');
  lockIcons.forEach(icon => {
    icon.addEventListener('click', function() {
      if (icon.classList.contains('mdi-lock')) {
        icon.classList.remove('mdi-lock');
        icon.classList.add('mdi-lock-open');
      } else {
        icon.classList.remove('mdi-lock-open');
        icon.classList.add('mdi-lock');
      }
    });
  });

  // Add event listener to all draggable elements
  const draggableElements = document.querySelectorAll('.box');
  draggableElements.forEach(draggable => {
    draggable.addEventListener('dragstart', function(event) {
      const cell = event.target.closest('td');
      const lockIcon = cell.querySelector('.mdi-lock');

      if (lockIcon) {
        event.preventDefault(); // Prevent dragging if the lock icon is active
        event.stopPropagation(); // Stop propagation to prevent other drag events
      }
    });

    draggable.addEventListener('dragover', function(event) {
      const cell = event.target.closest('td');
      const lockIcon = cell.querySelector('.mdi-lock');

      if (lockIcon) {
        event.preventDefault(); // Prevent dropping if the lock icon is active
      }
    });
  });

  // Ensure that drop target checks if it's locked
  document.addEventListener('dragover', function(event) {
    event.preventDefault(); // Allow drop
  });

  document.addEventListener('drop', function(event) {
    const cell = event.target.closest('td');
    const lockIcon = cell.querySelector('.mdi-lock');

    if (lockIcon) {
      event.preventDefault(); // Prevent dropping if the lock icon is active
      event.stopPropagation(); // Stop propagation to prevent other drop events
    }
  });
});

////////////////////////////////////////////////////
function addNewRowAtTop() {
  const table = document.getElementById('issuetable');

  // Create a new row
  const newRow = table.insertRow(1); // Insert at position 1 to place after the header row

  // Number of cells in the new row
  const numCells = 3; // Adjust based on your table structure

  // Loop to create each cell with the specified HTML structure
  for (let cellIndex = 0; cellIndex < numCells; cellIndex++) {
    const newCell = newRow.insertCell(cellIndex);
    
    // Create the inner HTML structure for the cell
    newCell.innerHTML = `<span class="mdi mdi-lock-open" style="font-size: 25px;"></span>
      <div class="draggable-container" ondrop="drop(event)" ondragover="allowDrop(event)">
        <div class="box" id="box_1_${cellIndex}" contenteditable="true" draggable="true" ondragstart="drag(event)">
          <!-- Initial content if any, can be added here -->
        </div>
      </div>
    `;
  }

  // Update the IDs of all the rows and cells
  updateRowIDs();
}

function updateRowIDs() {
  const table = document.getElementById('issuetable');
  const rows = table.getElementsByTagName('tr');
  
  for (let rowIndex = 0; rowIndex < rows.length; rowIndex++) {
    const cells = rows[rowIndex].getElementsByTagName('td');
    
    for (let cellIndex = 0; cellIndex < cells.length; cellIndex++) {
      const box = cells[cellIndex].querySelector('.box');
      if (box) {
        box.id = `box_${rowIndex}_${cellIndex}`;
      }
    }
  }
}

 //////////////////////////////////////////////////////////////////////
 function allowDrop(ev) {
    ev.preventDefault();
}

function drag(ev) {
    const draggedElement = document.getElementById(ev.target.id);

    // Check if the dragged element has the mdi-lock class or is inside a locked container
    const isLocked = draggedElement.closest('td').querySelector('.mdi-lock');

    if (isLocked) {
        ev.preventDefault(); // Prevent dragging if the element or container is locked
    } else {
        ev.dataTransfer.setData("text/plain", ev.target.id);
    }
}

function drop(ev) {
    ev.preventDefault();

    const data = ev.dataTransfer.getData("text/plain");
    const draggedElement = document.getElementById(data);
    const dropTarget = ev.target;

    // Check if the drop target or its parent has the mdi-lock class
    const isDropTargetLocked = dropTarget.closest('td').querySelector('.mdi-lock');

    if (isDropTargetLocked) {
        return; // Prevent dropping if the drop target or its container is locked
    }

    // If the drop target is a container (td), move the dragged element into it
    if (dropTarget.classList.contains('draggable-container')) {
        if (dropTarget.firstChild && dropTarget.firstChild !== draggedElement) {
            // Swap the elements if the target container is not empty
            const targetElement = dropTarget.firstChild;
            const parentElement = draggedElement.parentElement;
            dropTarget.replaceChild(draggedElement, targetElement);
            parentElement.appendChild(targetElement);
        } else if (dropTarget !== draggedElement.parentElement) {
            dropTarget.appendChild(draggedElement);
        }
    }

    // If the drop target is a box, move the dragged element into its parent container
    if (dropTarget.classList.contains('box')) {
        const parentElement = dropTarget.parentElement;
        const originalParentElement = draggedElement.parentElement;
        parentElement.replaceChild(draggedElement, dropTarget);
        originalParentElement.appendChild(dropTarget);
    }
}
///////////////////////////////////////////////////////////
    // Function to get table data
 function getTableDataAsObjects() {
            const table = document.getElementById('issuetable');
            const rows = table.getElementsByTagName('tr');
            const data = [];
  
            // Loop through each row (skip header row)
            for (let rowIndex = 0; rowIndex < rows.length; rowIndex++) {
                const cells = rows[rowIndex].getElementsByTagName('td');
                const rowData = []; // Array to hold the cell data for the current row

                for (let cellIndex = 0; cellIndex < cells.length; cellIndex++) {
                    const cell = cells[cellIndex];
                    // let id="lock_"+rowData""+cellIndex;
                    // var a = document.getElementById(id)

                    const box = cell.querySelector('.box');
                      const span = cell.querySelector('span');
                  const spanClass = span ? span.className : '';console.log(spanClass)
          
                    rowData.push({
                        row: rowIndex,
                        box: cellIndex + 1,
                        content: cell.innerText.trim(),
                        date: new Date().toISOString().split('T')[0], // Format date as yyyy-mm-dd
                        lock: spanClass // Assuming a data attribute to indicate if locked
                    });
                }
    
                data.push(rowData); // Add the row data to the main data array
            }
            console.log(data);
            return data;
        }

        function saveData() {
            const data = getTableDataAsObjects();
            console.log(data);
            fetch('/saveData', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Success:', data);
            })
            .catch((error) => {
                console.error('Error:', error);
            });
        }

    </script>

  </body>
</html>